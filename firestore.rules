rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Função auxiliar para verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Função auxiliar para verificar se o usuário é master
    function isMasterUser(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc != null && userDoc.data.userType == 'master';
    }
    
    // Função auxiliar para verificar se o usuário é administrativo
    function isAdministrativeUser(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc != null && userDoc.data.userType == 'administrative';
    }
    
    // Função auxiliar para verificar se o usuário atual é master
    function isCurrentUserMaster() {
      return isAuthenticated() && isMasterUser(request.auth.uid);
    }

    // Função auxiliar para verificar se o usuário atual é master ou administrativo
    function isCurrentUserMasterOrAdmin() {
      return isAuthenticated() && 
        (isMasterUser(request.auth.uid) || isAdministrativeUser(request.auth.uid));
    }

    // Regras para a coleção users
    match /users/{userId} {
      // Permitir leitura para usuários autenticados
      allow read: if isAuthenticated();
      
      // Permitir criação/atualização/exclusão se:
      // 1. O usuário está autenticado E
      // 2. O usuário é master OU está editando seu próprio documento
      allow write: if isAuthenticated() && 
        (isCurrentUserMaster() || userId == request.auth.uid);
    }
    
    // Regras para a coleção alunos
    match /alunos/{alunoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }
    
    // Regras para a coleção matriculas
    match /matriculas/{matriculaId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isCurrentUserMasterOrAdmin();
    }
    
    // Regras para a coleção pagamentos
    match /pagamentos/{pagamentoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }
    
    // Regras para a coleção planos
    match /planos/{planoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isCurrentUserMaster();
    }
    
    // Regras para horários - permitir leitura pública
    match /horarios/{horarioId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Regras para agendamentos e seus horários - permitir leitura pública
    match /agendamentos/{agendamentoId} {
      allow read: if true; // Permitir leitura pública para verificar horários ocupados
      allow write: if true; // Permitir criação de agendamentos sem autenticação
      
      match /horarios/{horarioId} {
        allow read: if true; // Permitir leitura pública dos horários dos agendamentos
        allow write: if true; // Permitir criação de horários de agendamento sem autenticação
      }
    }
    
    // Regras para professores - permitir leitura pública
    match /professores/{professorId} {
      allow read: if true;
      allow write: if isAuthenticated() && isCurrentUserMaster();
    }
    
    // Regras para valores das aulas - permitir leitura pública
    match /valores_aulas/{valorId} {
      allow read: if true;
      allow write: if isAuthenticated() && isCurrentUserMaster();
    }

    // Regras para a coleção tarefas
    match /tarefas/{tarefaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }
    
    // Regras para a coleção movimentacoes
    match /movimentacoes/{movimentacaoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }

    // Regras para a coleção turmasData
    match /turmasData/{turmaId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }

    // Regras para a coleção produtos
    match /produtos/{produtoId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      allow delete: if isAuthenticated() && isCurrentUserMaster();
    }

    // Novas regras para a coleção products (específica para a cantina)
    match /products/{productId} {
      // Leitura permitida para usuários autenticados
      allow read: if isAuthenticated();
      
      // Escrita permitida para master ou administrativo
      allow write: if isAuthenticated() && isCurrentUserMasterOrAdmin();
      
      // Atualização de estoque permitida para master ou administrativo
      allow update: if isAuthenticated() && 
        isCurrentUserMasterOrAdmin() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock']);
    }
  }
} 